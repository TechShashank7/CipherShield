<!DOCTYPE html>
<html>
<head>
    <title>Cyber Immunity Challenge</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>

<div class="container">

    <h1>Cyber Immunity Challenge</h1>
    <div class="header-bar">
    <div>
        <strong>Round {{ round }} of 7</strong>
    </div>
    <div>
        Risk Score: <span id="liveScore">{{ risk }}</span>
    </div>
</div>

<div class="progress-container">
    <div class="progress-fill" id="riskBar"></div>
</div>

    <div class="card">
        <h3>Analyze the Message Carefully</h3>

        <div class="simulation-box">
            {{ scenario.message }}
        </div>

        <form id="challengeForm">
            <h4>What looks suspicious? (Select all that apply)</h4>

            <label><input type="checkbox" name="flags" value="link"> Suspicious Link</label><br>
            <label><input type="checkbox" name="flags" value="authority"> Authority Misuse</label><br>
            <label><input type="checkbox" name="flags" value="urgency"> Urgency Tactic</label><br>
            <label><input type="checkbox" name="flags" value="reward"> Reward Lure</label><br>
            <label><input type="checkbox" name="flags" value="grammar"> Grammar Issue</label><br>

            <h4>What would you do?</h4>

            <label><input type="radio" name="action" value="click" required> Click Link</label><br>
            <label><input type="radio" name="action" value="verify"> Verify on official website</label><br>
            <label><input type="radio" name="action" value="ignore"> Ignore message</label><br>
            <label><input type="radio" name="action" value="share"> Share OTP / Details</label><br><br>

            <button type="submit">Submit Answer</button>

        </form>
    </div>

</div>
<script>
window.addEventListener("DOMContentLoaded", function() {
    const initialScore = parseInt(document.getElementById("liveScore").innerText);
    document.getElementById("riskBar").style.width = initialScore + "%";
});
function animateScore(newScore) {
    const scoreEl = document.getElementById("liveScore");
    const bar = document.getElementById("riskBar");

    let current = parseInt(scoreEl.innerText);

    const interval = setInterval(() => {
        if (current === newScore) {
            clearInterval(interval);
        } else {
            current += (newScore > current ? 1 : -1);
            scoreEl.innerText = current;
            bar.style.width = current + "%";
        }
    }, 10);
}

document.getElementById("challengeForm").addEventListener("submit", function(e) {
    e.preventDefault();

    const formData = new FormData(this);

    fetch("/submit_round", {
        method: "POST",
        body: formData
    })
    .then(res => res.json())
    .then(data => {

        // Remove old feedback if exists
        const oldFeedback = document.querySelector(".feedback-card");
        if (oldFeedback) oldFeedback.remove();

        const feedbackDiv = document.createElement("div");
        feedbackDiv.classList.add("feedback-card");

        let explanation = "";

        if (data.success) {
            feedbackDiv.classList.add("feedback-success");
            explanation += "<h3>Strong Awareness Displayed</h3>";
            explanation += "<p>You correctly detected the manipulation patterns in this message.</p>";
        } else {
            feedbackDiv.classList.add("feedback-fail");
            explanation += "<h3>Vulnerability Detected</h3>";
            explanation += "<p>You missed some psychological red flags or chose a risky response.</p>";
        }

        if (data.selected_flags.length > 0) {
            explanation += `<p><strong>You flagged:</strong> ${data.selected_flags.join(", ")}</p>`;
        } else {
            explanation += `<p><strong>You did not flag any warning signs.</strong></p>`;
        }

        explanation += `<p><strong>Actual red flags:</strong> ${data.correct_flags.join(", ")}</p>`;

        if (data.action !== data.correct_action) {
            explanation += `<p><strong>Safer Action:</strong> ${data.correct_action}</p>`;
        }

        explanation += `<p><strong>Updated Cyber Risk Score:</strong> ${data.score}</p>`;

        feedbackDiv.innerHTML = explanation;

        document.querySelector(".card").appendChild(feedbackDiv);

        // Animate score update
        animateScore(data.score);

        // Add Next button
        const nextBtn = document.createElement("button");
        nextBtn.style.marginTop = "20px";

        if (!data.game_over) {
            nextBtn.innerText = "Next Round";
            nextBtn.onclick = function() {
                window.location.href = "/next_round";
            };
        } else {
            nextBtn.innerText = "See Final Result";
            nextBtn.onclick = function() {
                window.location.href = "/result";
            };
        }

        feedbackDiv.appendChild(nextBtn);

        // Disable submit button after answer
        document.querySelector("#challengeForm button").disabled = true;
    });
});

</script>
</body>
</html>